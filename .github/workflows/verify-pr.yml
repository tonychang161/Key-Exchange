name: Verify PR

on:
  pull_request:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get changed files
        id: changed-files
        run: |
          # Only allow new files (A), not modifications (M) or deletions (D)
          ADDED_FILES=$(git diff --name-only --diff-filter=A ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          
          # Check for disallowed operations
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          
          if [ -n "$MODIFIED" ] || [ -n "$DELETED" ]; then
            echo "❌ Only adding new files is allowed"
            [ -n "$MODIFIED" ] && echo "Modified: $MODIFIED"
            [ -n "$DELETED" ] && echo "Deleted: $DELETED"
            exit 1
          fi
          
          echo "all_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          KEY_FILES=$(echo "$ADDED_FILES" | grep '^keys/.*\.asc$' || true)
          echo "key_files<<EOF" >> $GITHUB_OUTPUT
          echo "$KEY_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Check each file contains only one key
        run: |
          KEY_FILES="${{ steps.changed-files.outputs.key_files }}"
          
          if [ -z "$KEY_FILES" ]; then
            exit 0
          fi
          
          FAILED=0
          
          for keyfile in $KEY_FILES; do
            KEY_COUNT=$(gpg --with-colons --import-options show-only --import "$keyfile" 2>/dev/null | grep "^pub:" | wc -l)
            
            if [ "$KEY_COUNT" -eq 0 ]; then
              echo "❌ No valid key found: $keyfile"
              FAILED=$((FAILED + 1))
            elif [ "$KEY_COUNT" -gt 1 ]; then
              echo "❌ Multiple keys ($KEY_COUNT) in file: $keyfile"
              FAILED=$((FAILED + 1))
            else
              echo "✅ Single key: $keyfile"
            fi
          done
          
          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "=========================================="
            echo "❌ Each .asc file must contain exactly one key"
            echo "=========================================="
            exit 1
          fi

      - name: Check for disallowed files
        run: |
          ALL_FILES="${{ steps.changed-files.outputs.all_files }}"
          
          if [ -z "$ALL_FILES" ]; then
            echo "No files changed"
            exit 0
          fi
          
          DISALLOWED=0
          
          for file in $ALL_FILES; do
            # Allow: keys/*.asc, signed/*/*.asc
            if [[ "$file" =~ ^keys/[^/]+\.asc$ ]]; then
              echo "✅ Allowed: $file"
            elif [[ "$file" =~ ^signed/[^/]+/[^/]+\.asc$ ]]; then
              echo "✅ Allowed: $file"
            else
              echo "❌ Disallowed: $file"
              DISALLOWED=$((DISALLOWED + 1))
            fi
          done
          
          if [ $DISALLOWED -gt 0 ]; then
            echo ""
            echo "=========================================="
            echo "❌ PR contains disallowed files!"
            echo "Only allowed:"
            echo "  - keys/<netid>.asc"
            echo "  - signed/<your-netid>/<other-netid>.asc"
            echo "=========================================="
            exit 1
          fi

      - name: Verify new keys have course signature
        run: |
          KEY_FILES="${{ steps.changed-files.outputs.key_files }}"
          
          if [ -z "$KEY_FILES" ]; then
            echo "No new keys to verify"
            exit 0
          fi
          
          python scripts/verify_key.py $KEY_FILES